<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kidney Tumor Classification & Risk Assessment</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        animation: slideDown 0.6s ease-out;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .container-main {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        animation: fadeIn 0.8s ease-out;
      }

      .step-indicator {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .step-content {
        display: none;
        padding: 40px;
      }

      .step-content.active {
        display: block;
        animation: fadeIn 0.5s ease-out;
      }

      .image-section {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 40px;
      }

      .image-container {
        width: 100%;
        max-width: 350px;
        height: 350px;
        border: 3px dashed #667eea;
        border-radius: 10px;
        margin: 0 auto 30px;
        overflow: hidden;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: none;
      }

      .image-container img.show {
        display: block;
      }

      .placeholder-text {
        color: #999;
        text-align: center;
      }

      .form-section {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
      }

      .form-section h5 {
        color: #667eea;
        font-weight: 600;
        margin-bottom: 20px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
      }

      .form-control,
      .form-control-static {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px 15px;
      }

      .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }

      .radio-group,
      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px 20px;
        flex-wrap: wrap;
      }

      .radio-option,
      .checkbox-option {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }

      .radio-option input,
      .checkbox-option input {
        cursor: pointer;
        width: 18px;
        height: 18px;
        flex-shrink: 0;
      }

      .radio-option label,
      .checkbox-option label {
        cursor: pointer;
        margin: 0;
        font-weight: 400;
        white-space: nowrap;
      }

      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 30px;
      }

      .btn-custom {
        padding: 12px 35px;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary-custom:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
      }

      .btn-success-custom {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
      }

      .btn-success-custom:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(17, 153, 142, 0.4);
      }

      .btn-custom:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      input[type="file"] {
        display: none;
      }

      .result-box {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 10px;
        padding: 30px;
        min-height: 250px;
      }

      .result-badge {
        font-size: 2.5rem;
        font-weight: 700;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        animation: popIn 0.5s ease-out;
      }

      .result-badge.tumor {
        background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        color: white;
      }

      .result-badge.normal {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
      }

      .risk-factors {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
      }

      .risk-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #ffe69c;
      }

      .risk-item:last-child {
        border-bottom: none;
      }

      .risk-label {
        font-weight: 600;
        color: #333;
      }

      .risk-probability {
        background: #ffc107;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.9rem;
      }

      .condition-box {
        background: #e8f4f8;
        border-left: 4px solid #17a2b8;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
      }

      .condition-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
      }

      .condition-label {
        font-weight: 600;
        color: #333;
      }

      .condition-probability {
        background: #17a2b8;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.9rem;
      }

      #loading {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      #loading.show {
        display: flex;
      }

      .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #667eea;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        animation: spin 1s linear infinite;
      }

      .loading-text {
        color: white;
        font-size: 1.3rem;
        margin-top: 25px;
        font-weight: 500;
      }

      .info-box {
        background: #e3f2fd;
        border-left: 4px solid #667eea;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        font-size: 0.95rem;
        color: #333;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.5);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8rem;
        }
        .button-group {
          flex-direction: column;
        }
        .btn-custom {
          width: 100%;
        }
        .radio-group,
        .checkbox-group {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1><i class="fas fa-heartbeat"></i> Kidney Health Assessment</h1>
      <p>AI-powered imaging & personalized risk analysis</p>
    </div>

    <div class="container-main">
      <div class="step-indicator">
        <span id="stepLabel">Step 1/3: Upload CT Scan Image</span>
      </div>

      <!-- STEP 1: Image Upload & Prediction -->
      <div id="step1" class="step-content active">
        <div class="row m-0">
          <div class="col-md-6 image-section">
            <h5 class="text-center mb-4">
              <i class="fas fa-image"></i> Upload CT Scan
            </h5>
            <div class="image-container">
              <div class="placeholder-text">
                <i
                  class="fas fa-cloud-upload-alt"
                  style="font-size: 3rem; color: #667eea"
                ></i>
                <p class="mt-3">Click "Choose Image" to upload</p>
              </div>
              <img id="photo" />
            </div>
            <div class="button-group">
              <label for="fileinput" class="btn-custom btn-primary-custom mb-0">
                <i class="fas fa-cloud-upload-alt"></i> Choose Image
              </label>
              <input type="file" id="fileinput" accept="image/*" />
            </div>
            <div class="info-box">
              <strong><i class="fas fa-info-circle"></i> Note:</strong> Upload a
              kidney CT scan image
            </div>
          </div>

          <div class="col-md-6 result-section">
            <h5 class="text-center mb-4">
              <i class="fas fa-chart-bar"></i> CT Scan Result
            </h5>
            <div class="result-box" id="imageResultContainer">
              <p style="color: #999">
                <i class="fas fa-magic"></i><br /><br />Upload an image and
                click Predict
              </p>
            </div>
            <div class="button-group">
              <button
                type="button"
                class="btn-custom btn-success-custom"
                id="predictImageBtn"
                disabled
              >
                <i class="fas fa-brain"></i> Analyze Scan
              </button>
              <button
                type="button"
                class="btn-custom btn-primary-custom"
                id="proceedToQuestionnaire"
                disabled
                style="display: none"
              >
                <i class="fas fa-arrow-right"></i> Proceed to Health Profile
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 2: Health Questionnaire -->
      <div id="step2" class="step-content">
        <div class="row m-0">
          <div class="col-12">
            <h4 class="mb-4">
              <i class="fas fa-clipboard-list"></i> Health Profile Questionnaire
            </h4>
            <p class="text-muted mb-4">
              Please answer these questions to help us assess your risk factors
              and provide personalized insights.
            </p>

            <!-- A. Symptoms -->
            <div class="form-section">
              <h5><i class="fas fa-stethoscope"></i> Current Symptoms</h5>

              <div class="form-group">
                <label>Blood in Urine (Hematuria)?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="hematuria_no"
                      name="hematuria"
                      value="0"
                      checked
                    />
                    <label for="hematuria_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="hematuria_yes"
                      name="hematuria"
                      value="1"
                    />
                    <label for="hematuria_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Flank Pain (between ribs & hips)?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="flank_pain_none"
                      name="flank_pain"
                      value="0"
                      checked
                    />
                    <label for="flank_pain_none">None</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="flank_pain_mild"
                      name="flank_pain"
                      value="1"
                    />
                    <label for="flank_pain_mild">Mild</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="flank_pain_severe"
                      name="flank_pain"
                      value="2"
                    />
                    <label for="flank_pain_severe">Severe</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Lower Back Pain?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="lower_back_pain_no"
                      name="lower_back_pain"
                      value="0"
                      checked
                    />
                    <label for="lower_back_pain_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="lower_back_pain_yes"
                      name="lower_back_pain"
                      value="1"
                    />
                    <label for="lower_back_pain_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Fever?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="fever_no"
                      name="fever"
                      value="0"
                      checked
                    />
                    <label for="fever_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="fever_yes" name="fever" value="1" />
                    <label for="fever_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Loss of Appetite?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="appetite_loss_no"
                      name="appetite_loss"
                      value="0"
                      checked
                    />
                    <label for="appetite_loss_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="appetite_loss_yes"
                      name="appetite_loss"
                      value="1"
                    />
                    <label for="appetite_loss_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Unexplained Weight Loss?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="weight_loss_no"
                      name="weight_loss"
                      value="0"
                      checked
                    />
                    <label for="weight_loss_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="weight_loss_yes"
                      name="weight_loss"
                      value="1"
                    />
                    <label for="weight_loss_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Fatigue?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="fatigue_no"
                      name="fatigue"
                      value="0"
                      checked
                    />
                    <label for="fatigue_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="fatigue_yes"
                      name="fatigue"
                      value="1"
                    />
                    <label for="fatigue_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Anemia Diagnosis?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="anemia_no"
                      name="anemia"
                      value="0"
                      checked
                    />
                    <label for="anemia_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="anemia_yes"
                      name="anemia"
                      value="1"
                    />
                    <label for="anemia_yes">Yes</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- B. Medical History -->
            <div class="form-section">
              <h5><i class="fas fa-hospital"></i> Medical History</h5>

              <div class="form-group">
                <label>Hypertension (High Blood Pressure)?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="hypertension_no"
                      name="hypertension"
                      value="0"
                      checked
                    />
                    <label for="hypertension_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="hypertension_yes"
                      name="hypertension"
                      value="1"
                    />
                    <label for="hypertension_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Diabetes?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="diabetes_no"
                      name="diabetes"
                      value="0"
                      checked
                    />
                    <label for="diabetes_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="diabetes_yes"
                      name="diabetes"
                      value="1"
                    />
                    <label for="diabetes_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Chronic Kidney Disease?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="ckd_no"
                      name="ckd"
                      value="0"
                      checked
                    />
                    <label for="ckd_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="ckd_yes" name="ckd" value="1" />
                    <label for="ckd_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Family History of Kidney Tumors?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="fh_kidney_tumor_no"
                      name="fh_kidney_tumor"
                      value="0"
                      checked
                    />
                    <label for="fh_kidney_tumor_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="fh_kidney_tumor_yes"
                      name="fh_kidney_tumor"
                      value="1"
                    />
                    <label for="fh_kidney_tumor_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Family History of Hypertension?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="fh_hypertension_no"
                      name="fh_hypertension"
                      value="0"
                      checked
                    />
                    <label for="fh_hypertension_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="fh_hypertension_yes"
                      name="fh_hypertension"
                      value="1"
                    />
                    <label for="fh_hypertension_yes">Yes</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- C. Lifestyle -->
            <div class="form-section">
              <h5><i class="fas fa-apple-alt"></i> Lifestyle & Habits</h5>

              <div class="form-group">
                <label>Smoking Status?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="smoking_never"
                      name="smoking"
                      value="0"
                      checked
                    />
                    <label for="smoking_never">Never</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="smoking_former"
                      name="smoking"
                      value="1"
                    />
                    <label for="smoking_former">Former</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="smoking_current"
                      name="smoking"
                      value="2"
                    />
                    <label for="smoking_current">Current</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Alcohol Intake (drinks per week)?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="alcohol_none"
                      name="alcohol"
                      value="0"
                      checked
                    />
                    <label for="alcohol_none">None</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="alcohol_low"
                      name="alcohol"
                      value="1"
                    />
                    <label for="alcohol_low">&lt;7 drinks/week</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="alcohol_high"
                      name="alcohol"
                      value="2"
                    />
                    <label for="alcohol_high">&gt;7 drinks/week</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Height (cm)</label>
                <input
                  type="number"
                  class="form-control"
                  id="height"
                  placeholder="Enter height"
                  min="100"
                  max="250"
                />
              </div>

              <div class="form-group">
                <label>Weight (kg)</label>
                <input
                  type="number"
                  class="form-control"
                  id="weight"
                  placeholder="Enter weight"
                  min="20"
                  max="300"
                />
              </div>

              <div class="form-group">
                <label
                  >Occupational Chemical Exposure (chlorine, solvents)?</label
                >
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="chemical_exposure_no"
                      name="chemical_exposure"
                      value="0"
                      checked
                    />
                    <label for="chemical_exposure_no">No</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="chemical_exposure_yes"
                      name="chemical_exposure"
                      value="1"
                    />
                    <label for="chemical_exposure_yes">Yes</label>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Physical Activity Level?</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="activity_low"
                      name="activity"
                      value="0"
                      checked
                    />
                    <label for="activity_low">Low</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="activity_moderate"
                      name="activity"
                      value="1"
                    />
                    <label for="activity_moderate">Moderate</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="activity_high"
                      name="activity"
                      value="2"
                    />
                    <label for="activity_high">High</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="button-group">
              <button
                class="btn-custom btn-primary-custom"
                onclick="goToStep(1)"
              >
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button
                class="btn-custom btn-success-custom"
                onclick="analyzeRisk()"
              >
                <i class="fas fa-arrow-right"></i> Analyze Risk & Get Results
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 3: Risk Assessment Results -->
      <div id="step3" class="step-content">
        <div class="row m-0">
          <div class="col-12">
            <h4 class="mb-4">
              <i class="fas fa-analysis"></i> Your Personalized Risk Assessment
            </h4>
            <div id="riskResultsContainer"></div>
            <div class="button-group">
              <button
                class="btn-custom btn-primary-custom"
                onclick="goToStep(2)"
              >
                <i class="fas fa-arrow-left"></i> Back to Questionnaire
              </button>
              <button
                class="btn-custom btn-success-custom"
                onclick="resetAssessment()"
              >
                <i class="fas fa-redo"></i> Start New Assessment
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="loading">
      <div class="loader"></div>
      <p class="loading-text">
        <i class="fas fa-cog fa-spin"></i> Analyzing...
      </p>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
      let base_data = "";
      let scanResult = "";
      const stepsLabels = [
        "Step 1/3: Upload CT Scan Image",
        "Step 2/3: Health Profile",
        "Step 3/3: Risk Assessment",
      ];

      function goToStep(step) {
        document
          .querySelectorAll(".step-content")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById("step" + step).classList.add("active");
        document.getElementById("stepLabel").textContent =
          stepsLabels[step - 1];
        window.scrollTo(0, 0);
      }

      function predictImage() {
        if (!base_data) {
          alert("Please upload an image first!");
          return;
        }
        $("#loading").addClass("show");
        $.ajax({
          url: "/predict",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ image: base_data }),
          success: function (response) {
            $("#loading").removeClass("show");
            scanResult = response[0].image.toLowerCase();
            const resultBox = $("#imageResultContainer");

            if (scanResult === "tumor") {
              resultBox.html(`
                            <div>
                                <div class="result-badge tumor">
                                    <i class="fas fa-exclamation-triangle"></i><br>
                                    TUMOR DETECTED
                                </div>
                                <p style="color: #f5576c; font-weight: 600; font-size: 1.1rem;">
                                    A tumor has been detected in the scan.
                                </p>
                                <p style="color: #666; font-size: 0.95rem;">
                                    Please proceed to health assessment for personalized risk analysis.
                                </p>
                            </div>
                        `);
            } else {
              resultBox.html(`
                            <div>
                                <div class="result-badge normal">
                                    <i class="fas fa-check-circle"></i><br>
                                    NORMAL
                                </div>
                                <p style="color: #4facfe; font-weight: 600; font-size: 1.1rem;">
                                    No tumor detected.
                                </p>
                                <p style="color: #666; font-size: 0.95rem;">
                                    Proceed to health assessment to understand future prevention strategies.
                                </p>
                            </div>
                        `);
            }

            // Show the "Proceed to Health Profile" button
            $("#predictImageBtn").hide();
            $("#proceedToQuestionnaire").show().prop("disabled", false);
          },
          error: function (xhr) {
            $("#loading").removeClass("show");
            $("#imageResultContainer").html(
              `<div style="color: #d32f2f; text-align: center;"><i class="fas fa-times-circle" style="font-size: 3rem;"></i><p style="margin-top: 20px; font-weight: 600;">Error analyzing image</p></div>`
            );
          },
        });
      }

      function collectFormData() {
        const data = {
          ct_result: scanResult,
          hematuria: parseInt($('input[name="hematuria"]:checked').val()),
          flank_pain: parseInt($('input[name="flank_pain"]:checked').val()),
          lower_back_pain: parseInt(
            $('input[name="lower_back_pain"]:checked').val()
          ),
          fever: parseInt($('input[name="fever"]:checked').val()),
          appetite_loss: parseInt(
            $('input[name="appetite_loss"]:checked').val()
          ),
          weight_loss: parseInt($('input[name="weight_loss"]:checked').val()),
          fatigue: parseInt($('input[name="fatigue"]:checked').val()),
          anemia: parseInt($('input[name="anemia"]:checked').val()),
          hypertension: parseInt($('input[name="hypertension"]:checked').val()),
          diabetes: parseInt($('input[name="diabetes"]:checked').val()),
          ckd: parseInt($('input[name="ckd"]:checked').val()),
          fh_kidney_tumor: parseInt(
            $('input[name="fh_kidney_tumor"]:checked').val()
          ),
          fh_hypertension: parseInt(
            $('input[name="fh_hypertension"]:checked').val()
          ),
          smoking: parseInt($('input[name="smoking"]:checked').val()),
          alcohol: parseInt($('input[name="alcohol"]:checked').val()),
          height: parseFloat($("#height").val()) || 170,
          weight: parseFloat($("#weight").val()) || 70,
          chemical_exposure: parseInt(
            $('input[name="chemical_exposure"]:checked').val()
          ),
          activity_level: parseInt($('input[name="activity"]:checked').val()),
        };
        return data;
      }

      function analyzeRisk() {
        const formData = collectFormData();
        $("#loading").addClass("show");

        $.ajax({
          url: "/analyze_risk",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(formData),
          success: function (response) {
            $("#loading").removeClass("show");
            displayRiskResults(response);
            goToStep(3);
          },
          error: function (xhr) {
            $("#loading").removeClass("show");
            alert("Error analyzing risk profile");
            console.error(xhr.responseText);
          },
        });
      }

      function displayRiskResults(data) {
        const container = $("#riskResultsContainer");
        let html = `<div class="result-box">`;

        // Show CT Scan Result
        if (data.ct_result === "tumor") {
          html += `
                    <div class="result-badge tumor">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        TUMOR DETECTED
                    </div>
                    <h5 style="color: #f5576c; margin-top: 20px;">Based on your scan and health profile, here are the likely contributing factors:</h5>
                `;
        } else {
          html += `
                    <div class="result-badge normal">
                        <i class="fas fa-check-circle"></i><br>
                        SCAN NORMAL
                    </div>
                    <h5 style="color: #4facfe; margin-top: 20px;">Your scan is normal. However, monitor these potential future risk factors:</h5>
                `;
        }

        // Risk Factors
        if (data.risk_factors && Object.keys(data.risk_factors).length > 0) {
          html += `<div class="risk-factors">
                    <h6 style="color: #856404; margin-bottom: 15px;"><i class="fas fa-warning"></i> Risk Factors</h6>`;

          for (const [factor, prob] of Object.entries(data.risk_factors)) {
            if (prob > 0.2) {
              const percentage = (prob * 100).toFixed(1);
              html += `
                            <div class="risk-item">
                                <span class="risk-label">${factor
                                  .replace(/_/g, " ")
                                  .toUpperCase()}</span>
                                <span class="risk-probability">${percentage}%</span>
                            </div>
                        `;
            }
          }
          html += `</div>`;
        }

        // Associated Conditions
        if (
          data.associated_conditions &&
          Object.keys(data.associated_conditions).length > 0
        ) {
          html += `<div class="condition-box">
                    <h6 style="color: #0c5460; margin-bottom: 15px;"><i class="fas fa-hospital"></i> Associated Conditions</h6>`;

          for (const [condition, prob] of Object.entries(
            data.associated_conditions
          )) {
            if (prob > 0.2) {
              const percentage = (prob * 100).toFixed(1);
              html += `
                            <div class="condition-item">
                                <span class="condition-label">${
                                  condition
                                    .replace(/_/g, " ")
                                    .charAt(0)
                                    .toUpperCase() +
                                  condition.replace(/_/g, " ").slice(1)
                                }</span>
                                <span class="condition-probability">${percentage}%</span>
                            </div>
                        `;
            }
          }
          html += `</div>`;
        }

        html += `</div>`;
        container.html(html);
      }

      function resetAssessment() {
        base_data = "";
        scanResult = "";
        document.getElementById("fileinput").value = "";
        document.getElementById("photo").classList.remove("show");
        document.querySelector(".placeholder-text").style.display = "block";
        document.getElementById("predictImageBtn").disabled = true;

        // Use jQuery for show/hide
        $("#predictImageBtn").show();
        $("#proceedToQuestionnaire").hide();

        document.getElementById("imageResultContainer").innerHTML =
          '<p style="color: #999;"><i class="fas fa-magic"></i><br><br>Upload an image and click Predict</p>';

        // Reset all form fields
        document.querySelectorAll("input[type='radio']").forEach((input) => {
          if (input.defaultChecked) {
            input.checked = true;
          } else {
            input.checked = false;
          }
        });
        document.querySelectorAll("input[type='number']").forEach((input) => {
          input.value = "";
        });

        goToStep(1);
      }

      $(document).ready(function () {
        // File upload handler
        $("#fileinput").change(function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const img = new Image();
              img.crossOrigin = "Anonymous";
              img.onload = function () {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.height = this.height;
                canvas.width = this.width;
                ctx.drawImage(this, 0, 0);
                base_data = canvas
                  .toDataURL("image/jpeg", 1.0)
                  .replace(/^data:image.+;base64,/, "");
                $("#photo").attr("src", e.target.result).addClass("show");
                $(".placeholder-text").hide();
                $("#predictImageBtn").prop("disabled", false);
                $("#proceedToQuestionnaire").hide(); // Hide when new image is selected
                $("#proceedToQuestionnaire").prop("disabled", true);
              };
              img.src = e.target.result;
            };
            reader.readAsDataURL(this.files[0]);
          }
        });

        // Predict button
        $("#predictImageBtn").click(function () {
          predictImage();
        });

        // Proceed to Questionnaire button
        $("#proceedToQuestionnaire").click(function () {
          goToStep(2);
        });
      });
    </script>
  </body>
</html>
